<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Bwelco | 封光</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#303F9F">
  
  
  <meta name="keywords" content="undefined">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Bwelco">
<meta property="og:url" content="http://bwelco.coding.me/index.html">
<meta property="og:site_name" content="Bwelco">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bwelco">
<meta name="twitter:description">
  
  <meta name="summary" content="null">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu"  >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="http://o8yrrj7hr.bkt.clouddn.com/HexoHead.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">bwelco</h5>
        <a href="mailto:undefined" title="morefreefg@gmail.com" class="mail">morefreefg@gmail.com</a>
      </hgroup>
    </div>
  </div>
  <ul class="nav flex-col">
    
        <li class="waves-block waves-effect active">
          <a href="/"  >
            <i class="icon icon-lg icon-home"></i>
            主页
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/archives"  >
            <i class="icon icon-lg icon-archives"></i>
            时光轴
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/tags"  >
            <i class="icon icon-lg icon-tags"></i>
            标签
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="https://github.com/bwelco" target="_blank" >
            <i class="icon icon-lg icon-github"></i>
            Github
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="http://www.weibo.com/bwelco" target="_blank" >
            <i class="icon icon-lg icon-weibo"></i>
            微博
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/"  >
            <i class="icon icon-lg icon-link"></i>
            简历
          </a>
        </li>
    
  </ul>

  <footer class="footer">
  <p>Bwelco &copy; 2016</p>
</footer>

</div>

  </nav>
  <main id="main">
    <header class="header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Bwelco</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">Bwelco</h1>
    <h5 class="subtitle">封光</h5>
  </div>
</header>

    <div class="container body-wrap">
      
  <ul class="post-list">
  
    <li class="post-list-item">
  <article id="post-EventBus-3-0-源码解析" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/12/06/EventBus-3-0-源码解析/">EventBus 3.0 源码解析</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col"></div>
        <time datetime="2016-12-06T10:04:00.000Z" itemprop="datePublished" class="post-tiem">
  2016-12-06
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>EventBus是greenrobot发布的一个用于事件订阅和发布的框架,其最大的贡献在于将事件的订阅和发布很好地解耦，使代码更优雅，逻辑更清晰。<br>EventBus的主要特点如下:</p>
<p>组件解耦<br>解耦事件订阅和发布者<br>在Activitives,Fragments和后台线程的使用中表现良好<br>避免了复杂且易导致错误的依赖和生命周期问题<br>简化代码<br>足够快<br>轻量(大约50K)<br>已经在100,000,000+个应用上得到了证明<br>具有一些高级特色,如负责传递的线程,订阅优先级,粘性事件等.<br>下面就让我们一起揭开EventBus的神秘面纱。</p>
<h3 id="1-EventBusAnnotationProcessor-EventBus的正确打开方式"><a href="#1-EventBusAnnotationProcessor-EventBus的正确打开方式" class="headerlink" title="1.EventBusAnnotationProcessor:EventBus的正确打开方式"></a>1.EventBusAnnotationProcessor:EventBus的正确打开方式</h3><p>网上有很多介绍EventBus的文章,但是几乎没有提到EventBusAnnotationProcessor的。实际上,从EventBus 3开始引入了注解,它的主要作用在于使用注解而非反射来解析订阅信息,并且这个过程是在编译时而非运行时完成的,因而可使EventBus中的事件订阅节约很多时间。</p>
<p>要使用EventBus 3的这个新特性,需要以下几步:</p>
<p>添加依赖<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'org.greenrobot:eventbus:3.0.0'</span></span><br></pre></td></tr></table></figure></p>
<p>由于注解依赖android-apt-plugin,故需要在项目的gradle的dependencies中引入apt,如下:<br> <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classpath</span> <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></span><br></pre></td></tr></table></figure></p>
<p>在app module的build.gradle中应用apt插件,并设置apt生成的索引的包名和类名，如果不设置的话在编译时会报错。<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apply</span> plugin: <span class="string">'com.neenbedankt.android-apt'</span></span><br><span class="line"></span><br><span class="line">apt &#123;</span><br><span class="line">    <span class="section">arguments</span> &#123;</span><br><span class="line">        <span class="attribute">eventBusIndex</span> <span class="string">"wang.imallen.eventbusannotationsample.MyEventBusIndex"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后,需要在app module的dependencies中引入EventBusAnnotationProcessor:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apt</span> <span class="string">'org.greenrobot:eventbus-annotation-processor:3.0.1'</span></span><br></pre></td></tr></table></figure></p>
<p>完成以上几步后,重新编译一次,即可在app/build/generated/source/apt/debug/下看到生成的MyEventBusIndex类，如下是我的示例中生成的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** This class is generated by EventBus, do not edit. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventBusIndex</span> <span class="keyword">implements</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();</span><br><span class="line"></span><br><span class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(ThirdActivity.class, <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onStickyEvent"</span>, wang.imallen.eventbusannotationsample.bean.UserInfo.class,</span><br><span class="line">                    ThreadMode.MAIN, <span class="number">0</span>, <span class="keyword">true</span>),</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(MainActivity.class, <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEvent"</span>, wang.imallen.eventbusannotationsample.simple.Event.class,</span><br><span class="line">                    ThreadMode.MAIN),</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventPosting"</span>,</span><br><span class="line">                    wang.imallen.eventbusannotationsample.threadmode.SecondEvent.class),</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventBackground"</span>,</span><br><span class="line">                    wang.imallen.eventbusannotationsample.threadmode.ThirdEvent.class, ThreadMode.BACKGROUND),</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventAsync"</span>,</span><br><span class="line">                    wang.imallen.eventbusannotationsample.threadmode.FourthEvent.class, ThreadMode.ASYNC),</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIndex</span><span class="params">(SubscriberInfo info)</span> </span>&#123;</span><br><span class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> info;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是,项目中至少要有一个订阅信息，否则EventBusProcessor获取到的订阅信息为空,自然不生成相应的类了。<br>重新编译之后,在第一次使用EventBus之前(如Application或SplashActivity中),添加如下代码,以使Index生效:</p>
<p> EventBus eventBus=EventBus.builder().addIndex(new MyEventBusIndex()).build();</p>
<p>至于EventBus中常规事件和sticky事件的发布和订阅,都是非常简单的事情,也不是本文的重点,故不再赘述,就有一点需要注意,EventBus 3中sticky events的订阅是在注解中添加类似@Subscriber(sticky=true,threadMode=ThreadMode.MAIN)的属性.<br>读者可以fork我在github中的这个示例进行了解: EventBusProcessor使用示例</p>
<p>需要注意的是,如果不利用EventBusAnnotationProcessor,则EventBus 3的解析速度反而会比之前版本更慢。<br>如下是square发布的EventBus3与之前版本在Nexus One,Nexus 5,Nexus 9上的表现对比:</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_2.png" alt="2"><br><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_3.png" alt="3"><br><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_4.png" alt="4"></p>
<h3 id="2-EventBus-3-0-0架构"><a href="#2-EventBus-3-0-0架构" class="headerlink" title="2.EventBus 3.0.0架构"></a>2.EventBus 3.0.0架构</h3><p>EventBus 3.0.0的发布和订阅事件的架构如下:<br><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_5.png" alt="5"></p>
<p>仍然是在某个线程发布后,通过EventBus分发到不同线程中的Subscriber,这一点与之前版本的并无不同。</p>
<p>EventBus 3.0.0的UML图如下:</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_6.png" alt="6"></p>
<p>需要重点关注的类有EventBus,SubscriberMethodFinder,FindState,SubscriberInfo,PostingThreadState,HandlerPoster,BackgroundPoster,<br>AsyncPoster,PendingPost,Subscription,SubscriberMethod,后面的分析也主要与这些类有关.</p>
<h3 id="3-事件订阅-解除订阅"><a href="#3-事件订阅-解除订阅" class="headerlink" title="3.事件订阅/解除订阅"></a>3.事件订阅/解除订阅</h3><p>下面的代码讲解将结合 EventBusProcessor使用示例 进行。</p>
<p>事件订阅的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//subscriberClass是类似wang.imallen.eventbusannotationsample.MainActivity这样的</span></span><br><span class="line">        Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">        <span class="comment">//subscriberMethods是类似MainActivity中的onEvent(),onEventAsync(),onEventBackground(),onEventMain(),onEventPosting(),onStickyEvent()这样的</span></span><br><span class="line">        List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">                subscribe(subscriber, subscriberMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>subscriberClass就是订阅者所属的Class,如MainActivity.class,之后利用subscriberMethodFinder查找subscriberClass中的订阅方法，其中findSubscriberMethods()方法如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</span><br><span class="line">       <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ignoreGeneratedIndex默认为false,因为反射成本高</span></span><br><span class="line">       <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</span><br><span class="line">           subscriberMethods = findUsingReflection(subscriberClass);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           subscriberMethods = findUsingInfo(subscriberClass);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</span><br><span class="line">                   + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           METHOD_CACHE.put(subscriberClass, subscriberMethods);</span><br><span class="line">           <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>由于反射成本高,而且EventBus 3引入了EventBusAnnotationProcessor,故默认ignoreGeneratedIndex为false,需要注意的是,<br>如果设置ignoreGeneratedIndex为true,则前面使用的MyEventBusIndex无效,还是会走反射解析的分支。</p>
<p>要证实这一点很简单,进入findUsingReflection()方法看一下即可:</p>
<h4 id="3-1-使用反射获取订阅信息"><a href="#3-1-使用反射获取订阅信息" class="headerlink" title="3.1 使用反射获取订阅信息"></a>3.1 使用反射获取订阅信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">       FindState findState = prepareFindState();</span><br><span class="line">       findState.initForSubscriber(subscriberClass);</span><br><span class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">           findUsingReflectionInSingleClass(findState);</span><br><span class="line">           findState.moveToSuperclass();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>调用的是findUsingReflectionInSingleClass(),其代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">      Method[] methods;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></span><br><span class="line">          <span class="comment">//methods是所有声明的方法，不包括只在基类的方法,如MainActivity中就是onCreate(),onDestroy(),onEvent(),onEventAsync(),onEventBackground(),onEventMain(),onEventPosting(),onStickEvent(),openSecondActivity()</span></span><br><span class="line">          methods = findState.clazz.getDeclaredMethods();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">          <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></span><br><span class="line">          methods = findState.clazz.getMethods();</span><br><span class="line">          findState.skipSuperClasses = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">          <span class="keyword">int</span> modifiers = method.getModifiers();</span><br><span class="line">          <span class="comment">//必须是public和非static,非abstract,非bridge,非synthetic的方法</span></span><br><span class="line">          <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</span><br><span class="line">              Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">              <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</span><br><span class="line">                  Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</span><br><span class="line">                  <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      <span class="comment">//evnetType是类似wang.imallen.eventbusample.simple.Event这样的事件类型</span></span><br><span class="line">                      Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">                      <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</span><br><span class="line">                          ThreadMode threadMode = subscribeAnnotation.threadMode();</span><br><span class="line">                          findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</span><br><span class="line">                                  subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</span><br><span class="line">                  String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</span><br><span class="line">                          <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</span><br><span class="line">              String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</span><br><span class="line">                      <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>代码逻辑很简单,就是先获取这个类的declared方法,然后选择其中是public和非static,非abstract,非bridge,非synthetic的方法，如果该方法的注解为Subscribe，则说明它是订阅事件的方法,解析注解参数,最后将解析结果到findState.subscriberMethods中.<br>里面有个小细节就是Class&lt;?&gt;eventType=parameterTypes[0],这意味着即使订阅方法中有多个参数，也只取第一个，如果确认该订阅对象中还未添加该eventtype的方法,则添加到findState.subscriberMethods中，其中checkAdd()方法的代码很简单,不展开分析了。<br>从这里引出一个细节:在一个订阅对象中,同一个事件类型只能有一个回调。</p>
<h4 id="3-2-使用EventBusAnnotationProcessor解析结果获取订阅信息"><a href="#3-2-使用EventBusAnnotationProcessor解析结果获取订阅信息" class="headerlink" title="3.2 使用EventBusAnnotationProcessor解析结果获取订阅信息"></a>3.2 使用EventBusAnnotationProcessor解析结果获取订阅信息</h4><p>回到findSubscriberMethods()这个方法,ignoreGeneratedIndex为false时,通过findUsingInfo()方法来获取订阅信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">       FindState findState = prepareFindState();</span><br><span class="line">       findState.initForSubscriber(subscriberClass);</span><br><span class="line">       <span class="comment">//使用while而不是if的原因是findState.moveToSuperclass()会切换findState.clazz对象为基类Class对象,从而循环解析</span></span><br><span class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">           findState.subscriberInfo = getSubscriberInfo(findState);</span><br><span class="line">           <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">               SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</span><br><span class="line">               <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</span><br><span class="line">                       findState.subscriberMethods.add(subscriberMethod);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//如果发现获取不到subscriberInfo的话,就还是要使用反射来获取</span></span><br><span class="line">               findUsingReflectionInSingleClass(findState);</span><br><span class="line">           &#125;</span><br><span class="line">           findState.moveToSuperclass();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>进入getSubscriberInfo()查看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span> &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           SubscriberInfo superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo();</span><br><span class="line">           <span class="keyword">if</span> (findState.clazz == superclassInfo.getSubscriberClass()) &#123;</span><br><span class="line">               <span class="keyword">return</span> superclassInfo;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (subscriberInfoIndexes != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (SubscriberInfoIndex index : subscriberInfoIndexes) &#123;</span><br><span class="line">               SubscriberInfo info = index.getSubscriberInfo(findState.clazz);</span><br><span class="line">               <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> info;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里由于subscriberInfo为null,故执行的是第二个分支，即在subscriberInfoIndexes中寻找,那这个subscriberInfoIndexes来自哪里呢？<br>可以看到，它是在constructor中被赋值的,而subscriberMethodFinder就在EventBus的constructor中创建的,这个subscriberInfoIndexes来自builder.subscriberInfoIndexes,而EventBusBuilder中的subscriberInfoIndexes就是来自于第一节中我们提到的如下代码:</p>
<p>EventBus eventBus = EventBus.builder().addIndex(new MyEventBusIndex()).build();</p>
<p>所以,MyEventBusIndex起作用的地方是在SubscriberMethodFinder中,结合MyEventBusIndex的代码可知,EventBusAnnotationProcessor解析出订阅信息，之后以订阅对象的Class为key放入到HashMap中(有的例外的是sticky events,这个在后面会分析),然后在SubscriberMethodFinder的getSubscriberInfo()中,根据findState.clazz来解析已有的结果,如果查找到了则直接返回。</p>
<p>回到findUsingInfo()中,仍然是要检查是否已添加同类型事件的回调,如果没有添加才会添加到findState.subscriberMethods中.</p>
<p>需要注意的是else中findUsingReflectionInSingleClass(findState),我个人认为是冗余代码,除非EventBusAnnotationProcessor解析出错或不完整,某种程度上是对EventBusAnnotationProcessor不自信的表现,期待作者在后面去掉吧。</p>
<p>注意return语句之前的findState.moveToSuperclass()这句，它其实是将findState中的clazz对象换成基类的,也就是说，事件订阅是可以继承的,之后循环之前的过程。</p>
<h4 id="3-3-绑定订阅对象和方法"><a href="#3-3-绑定订阅对象和方法" class="headerlink" title="3.3 绑定订阅对象和方法"></a>3.3 绑定订阅对象和方法</h4><p>回到EventBus#register()中,在获取subscriberMethods之后，就是遍历各订阅方法,逐个绑定。subscribe()的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Must be called in synchronized block</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//eventType是类似wang.imallen.eventbusannotationsample.simpel.Event这样的</span></span><br><span class="line">       Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line">       Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</span><br><span class="line">       CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">       <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">           subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">           subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></span><br><span class="line">                       + eventType);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">       <span class="comment">//注意这里是i&lt;=size,是为了考虑到subscriptions为空的情况也能添加newSubscription到subscriptions中</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</span><br><span class="line">           <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">               subscriptions.add(i, newSubscription);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line">       <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</span><br><span class="line">           subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">           <span class="comment">//subscriber是类似MainActivity,而subscribedEvents是类似MainActivity中涉及到的所有eventType,如Event.class,FirstEvent.class,SecondEvent.class,...,UserInfo.class</span></span><br><span class="line">           typesBySubscriber.put(subscriber, subscribedEvents);</span><br><span class="line">       &#125;</span><br><span class="line">       subscribedEvents.add(eventType);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">           <span class="comment">//eventInheritance表示是否要考虑继承</span></span><br><span class="line">           <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">               <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></span><br><span class="line">               <span class="comment">// <span class="doctag">Note:</span> Iterating over all events may be inefficient with lots of sticky events,</span></span><br><span class="line">               <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></span><br><span class="line">               <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></span><br><span class="line">               Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">               <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                   Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                   <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                       Object stickyEvent = entry.getValue();</span><br><span class="line">                       <span class="comment">//给这个新的订阅者发送所有eventType类型或其子类的事件</span></span><br><span class="line">                       checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//如果不考虑继承,则只要给新的订阅者发送eventType这个类型的最近一次的粘性事件</span></span><br><span class="line">               Object stickyEvent = stickyEvents.get(eventType);</span><br><span class="line">               checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法略长,分为以下几步分析:</p>
<p>首先根据subscriber和subscriberMethod生成一个Subscription对象<br>之后从subscriptionsByEventType这个Map中获取对应eventType的所有Subscription对象,如果为空则新建,否则判断是否已经包含newSubscription,如包含则抛出已订阅的异常<br>遍历subscriptions,如果发现subscriberMethod的优先级比某个Subscription对象中的优先级高,则用当前的Subscription对象取代它，之后跳出循环<br>typesBySubscriber是以订阅对象为key,事件类型列表为value的Map,将当前的事件类型添加到对应的List中即可<br>最后一部分比较特殊,如果订阅的是粘性事件,则要分两种情况:<br>如果要考虑事件继承(EventBusBuilder中默认为true)，则需要遍历stickyEvents这个以事件的Class为key,事件本身为value的Map,如果发现某个事件类型是eventType的子类(就是eventType.isAssignableFrom(candidateEventType)的含义),则要发布这个事件类型对应的事件(也就是该事件类型最近一次事件)给这个订阅方法。至于事件发布的代码,在第4节会分析。<br>如果不考虑事件继承,则只需要将eventType最近一次的事件（如果有的话)发送给这个订阅方法即可</p>
<h4 id="3-4-解除订阅"><a href="#3-4-解除订阅" class="headerlink" title="3.4 解除订阅"></a>3.4 解除订阅</h4><p>解除订阅的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Unregisters the given subscriber from all event classes. */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">       List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</span><br><span class="line">       <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</span><br><span class="line">               unsubscribeByEventType(subscriber, eventType);</span><br><span class="line">           &#125;</span><br><span class="line">           typesBySubscriber.remove(subscriber);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Log.w(TAG, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>代码很简单,就是解除与该订阅对象关联的所有事件类型.unsubscribeByEventType()的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">       List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">       <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">               Subscription subscription = subscriptions.get(i);</span><br><span class="line">               <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</span><br><span class="line">                   subscription.active = <span class="keyword">false</span>;</span><br><span class="line">                   subscriptions.remove(i);</span><br><span class="line">                   i--;</span><br><span class="line">                   size--;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法就是根据事件类型获取所有的订阅信息,如果该订阅信息的订阅对象为当前订阅对象,则将其移除.</p>
<p>解除订阅的逻辑很简单,就不画流程图了.</p>
<h4 id="3-5-事件订阅总结"><a href="#3-5-事件订阅总结" class="headerlink" title="3.5 事件订阅总结"></a>3.5 事件订阅总结</h4><p>至此,事件订阅就基本分析完了,我们可以从中梳理出如下流程:</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_7.png" alt="7"></p>
<p>其中红线标出的是我认为不合理的地方。</p>
<h2 id="4-事件发布"><a href="#4-事件发布" class="headerlink" title="4.事件发布"></a>4.事件发布</h2><h4 id="4-1-发布普通事件"><a href="#4-1-发布普通事件" class="headerlink" title="4.1 发布普通事件"></a>4.1 发布普通事件</h4><p>post()的代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Posts the given event to the event bus. */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">       PostingThreadState postingState = currentPostingThreadState.get();</span><br><span class="line">       List&lt;Object&gt; eventQueue = postingState.eventQueue;</span><br><span class="line">       eventQueue.add(event);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!postingState.isPosting) &#123;</span><br><span class="line">           postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();</span><br><span class="line">           postingState.isPosting = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">if</span> (postingState.canceled) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</span><br><span class="line">                   postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               postingState.isPosting = <span class="keyword">false</span>;</span><br><span class="line">               postingState.isMainThread = <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>首先获取当前线程的PostingThreadState对象，实现方式是ThreadLocal<br>然后将当前event添加到postingState的事件队列中<br>如果当前线程没有正在发布事件,则遍历当前线程的事件队列,将事件逐个发布出去,其中postSingleEvent()的代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</span><br><span class="line">       Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">       <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">           List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</span><br><span class="line">           <span class="keyword">int</span> countTypes = eventTypes.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</span><br><span class="line">               Class&lt;?&gt; clazz = eventTypes.get(h);</span><br><span class="line">               subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!subscriptionFound) &#123;</span><br><span class="line">           <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</span><br><span class="line">               Log.d(TAG, <span class="string">"No subscribers registered for event "</span> + eventClass);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</span><br><span class="line">                   eventClass != SubscriberExceptionEvent.class) &#123;</span><br><span class="line">               post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里涉及到事件继承的问题(默认情况下eventInheritance为true,即要考虑事件继承),如果考虑事件继承,则要获取这个事件类型的所有基类和实现的接口,并且还要将基类的基类，以及接口的基类也包含进去。如下是lookupAllEventTypes()的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Looks up all Class objects including super classes and interfaces. Should also work for interfaces. */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&lt;?&gt;&gt; lookupAllEventTypes(Class&lt;?&gt; eventClass) &#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (eventTypesCache) &#123;</span><br><span class="line">         List&lt;Class&lt;?&gt;&gt; eventTypes = eventTypesCache.get(eventClass);</span><br><span class="line">         <span class="keyword">if</span> (eventTypes == <span class="keyword">null</span>) &#123;</span><br><span class="line">             eventTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">             Class&lt;?&gt; clazz = eventClass;</span><br><span class="line">             <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 eventTypes.add(clazz);</span><br><span class="line">                 addInterfaces(eventTypes, clazz.getInterfaces());</span><br><span class="line">                 clazz = clazz.getSuperclass();</span><br><span class="line">             &#125;</span><br><span class="line">             eventTypesCache.put(eventClass, eventTypes);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> eventTypes;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>代码很简单,就是循环获取基类以及基类的接口,并且将符合条件的事件类型添加到eventTypes中,最后将(eventClass,eventTypes)放入eventTypesCache中。</p>
<p>再回到postSingEvent()中,下面就是遍历eventTypes了,进入postSingleEventForEventType()中,代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</span><br><span class="line">      CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">          subscriptions = subscriptionsByEventType.get(eventClass);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</span><br><span class="line">              postingState.event = event;</span><br><span class="line">              postingState.subscription = subscription;</span><br><span class="line">              <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  postToSubscription(subscription, event, postingState.isMainThread);</span><br><span class="line">                  aborted = postingState.canceled;</span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                  postingState.event = <span class="keyword">null</span>;</span><br><span class="line">                  postingState.subscription = <span class="keyword">null</span>;</span><br><span class="line">                  postingState.canceled = <span class="keyword">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>如果eventClass对应的订阅信息不为空,则将当前事件逐个发布到各订阅对象中,真正的发布处理在postToSubscription()中,代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> POSTING:</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MAIN:</span><br><span class="line">                <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                    invokeSubscriber(subscription, event);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">                <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                    backgroundPoster.enqueue(subscription, event);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    invokeSubscriber(subscription, event);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASYNC:</span><br><span class="line">                asyncPoster.enqueue(subscription, event);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>显然，需要分线程模式为POSTING,MAIN,BACKGROUND,ASYNC这四种情况处理。</p>
<p>如果是POSTING模式,则直接回调事件订阅方法,说明POSTING模式代表发布和订阅回是在同一个线程;<br>如果要在主线程回调,而发布线程就是主线程的话，则直接回调;否则需要利用主线程发布代理(mainThreadPoster)来进行发布;<br>如果要在后台线程中回调,而发布线程是主线程的话,则需要利用后台线程发布代理(backgroundPoster)来进行发布,否则直接发布;<br>如果是异步发布,则不管当前是在什么线程,都是利用异步发布代理(asyncPoster)来进行发布<br>如果threadMode不是其中之一的话，则抛出异常.<br>到这里为止,普通事件的发布就基本梳理完了。</p>
<h4 id="4-2-发布sticky-event"><a href="#4-2-发布sticky-event" class="headerlink" title="4.2 发布sticky event"></a>4.2 发布sticky event</h4><p>粘性事件的发布代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * Posts the given event to the event bus and holds on to the event (because it is sticky). The most recent sticky</span><br><span class="line">   * event of an event's type is kept in memory for future access by subscribers using &#123;<span class="doctag">@link</span> Subscribe#sticky()&#125;.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (stickyEvents) &#123;</span><br><span class="line">          stickyEvents.put(event.getClass(), event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Should be posted after it is putted, in case the subscriber wants to remove immediately</span></span><br><span class="line">      post(event);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>非常简单，相比普通事件的发布,就只是多了一步:将当前事件put到当前事件类型对应的实体中。这样做的目的是为了在绑定粘性事件回调时可以将最近一次该事件类型的事件发布给它。</p>
<p>至此,我们可以梳理出发布事件的流程:</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/eventbus_8.png" alt="8"></p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2016/12/06/EventBus-3-0-源码解析/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-三星长按Home键搜索" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/06/19/三星长按Home键搜索/">三星长按Home键搜索</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
</div>
        <time datetime="2016-06-20T02:10:00.000Z" itemprop="datePublished" class="post-tiem">
  2016-06-19
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>手持一部Samsung Galaxy S7 Edge。长按Home键可以进行相关的操作，但是不是在默认程序里面设置的。<br>要跳转到专门的设置里面。<br>三星官方也并没有提供这个接口，Google一圈也搜索不到。<br>里面默认选择的除了三星自家的软件还有一个手机百度。长按Home键可以进行搜索。<br>这就很不爽了，难道我只能忍受百度这个大毒瘤么，要知道长按home键搜索也是个很实用的功能。</p>
<p>身为程序狗，默默打开反编译软件，结果看代码看了一圈也没什么相关的地方。这时候我扫了一眼AndroidMainfest。在相关Activity的标签下看到了这个<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.ASSIST"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ASSIST，设置那边也叫ASSIST， 这个应该逃不掉了吧。<br>好的。正文开始了。</p>
<p>下面就是做搜索界面，还是看百度的AndroidMainfest。这个标签下，<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>theme=<span class="string">"@style/NoTitleNoAnimationNoBackground"</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> &lt;style <span class="built_in">name</span>=<span class="string">"NoTitleNoAnimationNoBackground"</span> parent=<span class="string">"@style/NoTitle"</span>&gt;</span><br><span class="line">     &lt;<span class="built_in">item</span> <span class="built_in">name</span>=<span class="string">"android:windowBackground"</span>&gt;@color/fast_search_activity_transparent&lt;/<span class="built_in">item</span>&gt;</span><br><span class="line">     &lt;<span class="built_in">item</span> <span class="built_in">name</span>=<span class="string">"android:windowIsTranslucent"</span>&gt;<span class="literal">true</span>&lt;/<span class="built_in">item</span>&gt;</span><br><span class="line">     &lt;<span class="built_in">item</span> <span class="built_in">name</span>=<span class="string">"android:windowAnimationStyle"</span>&gt;@null&lt;/<span class="built_in">item</span>&gt;</span><br><span class="line"> &lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;style <span class="built_in">name</span>=<span class="string">"NoTitle"</span> parent=<span class="string">"@android:style/Theme.NoTitleBar"</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">item</span> <span class="built_in">name</span>=<span class="string">"android:windowBackground"</span>&gt;@color/window_background_color&lt;/<span class="built_in">item</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">item</span> <span class="built_in">name</span>=<span class="string">"android:windowContentOverlay"</span>&gt;@null&lt;/<span class="built_in">item</span>&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>这就可以实现背景透明了。</p>
<p>下面就是写个EditText，然后加一个ListView。<br>问题来了，listview数据哪里来。  百度并没有提供相关接口，怎么办呐？</p>
<p>抓包大法吼啊，开FireFox debug控制台，搜到相关接口是<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>//suggestion.baidu.com/su?action=opensearch&amp;wd=<span class="string">"keyword"</span></span><br></pre></td></tr></table></figure></p>
<p>返回一个json，自己解析下放到listView里面就行。</p>
<p>相关代码放到GitHub上面了</p>
<p><a href="https://github.com/bwelco/SumsungSearch/" target="_blank" rel="external">https://github.com/bwelco/SumsungSearch/</a></p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2016/06/19/三星长按Home键搜索/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-远程app使用教程及下载" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/09/22/远程app使用教程及下载/">远程app使用教程及下载</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
</div>
        <time datetime="2015-09-23T01:21:00.000Z" itemprop="datePublished" class="post-tiem">
  2015-09-22
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <h1 id="远程app使用教程及下载"><a href="#远程app使用教程及下载" class="headerlink" title="远程app使用教程及下载"></a>远程app使用教程及下载</h1><p>昨天写了个小程序。app控制电脑音量（送给苦于舍友放歌却屡教不改的童鞋。）</p>
<p>使用教程：</p>
<p>1：电脑端安装。 先把WindowsService.exe放入D盘的根目录下（直接把文件拖到d盘就行），然后右击install.bat，点击以管理员身份运行。360或者其他软件报毒的，如果你信任我就设置为信任，不要让360瞎bb。</p>
<p>安装过后，打开D盘下的MoreFree.txt</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720150622132358.png" alt="1"></p>
<p>如果不出错的话，可以看到 绑定ip：×××.×××.×××.×××</p>
<p>把这个ip填到手机app里面即可。</p>
<p>然后，请打开控制面板，搜索防火墙关键字，关闭防火墙。</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/U8T66DJ@B7@JOR9UA58.png" alt="2"></p>
<p>2：安卓，直接安装apk就行。</p>
<p>Tips：能使用的前提是，你手机跟被控制的电脑在同一局域网下面。</p>
<p>如果出错。</p>
<p>1：安装出错，请截图安装过程（运行install.bat的时候）。</p>
<p>2：运行出错，请打开D盘下的MoreFree.txt，并发给我，我给你分析。</p>
<p>卸载：</p>
<p>右击uninstall.bat，点击以管理员身份运行。</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720150622131932.png" alt="3"></p>
<p>APP截图:</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/Screenshot_2015-06-22-20-12-00.png" alt="4"></p>
<p><a href="http://o8yrrj7hr.bkt.clouddn.com/%E5%AE%A2%E6%88%B7%E7%AB%AF.zip" target="_blank" rel="external">点击此处下载</a></p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2015/09/22/远程app使用教程及下载/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-解决socket传输中数据丢失问题" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/07/18/解决socket传输中数据丢失问题/">解决socket传输中数据丢失问题</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
</div>
        <time datetime="2015-07-18T08:20:00.000Z" itemprop="datePublished" class="post-tiem">
  2015-07-18
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>[原创]欢迎转载。注明出处。</p>
<p>最近写一个小程序，想要添加文件上传/下载功能。</p>
<p>原始代码： client (send):</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    read(fd, <span class="keyword">buff,BUFF_SIZE);</span><br><span class="line"></span></span><br><span class="line">    send(soc, <span class="keyword">buff, </span><span class="keyword">BUFF_SIZE, </span><span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sever (receive):</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span><span class="comment">(1)</span></span><br><span class="line">&#123;</span><br><span class="line">    recv<span class="comment">(soc, buff, BUFF_SIZE, 0)</span>;</span><br><span class="line"></span><br><span class="line">    write<span class="comment">(fd, buff,BUFF_SIZE)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>奇怪的现象出现了，客户端一路到头，send函数和recv也没有出现任何错误，但是，文件大小严重缩水。<br>我又把buff重新设计，包含在结构体里面，里面包含检验信息flag，来保证两头传输正常。发现，在收发包的过程中，flag丢失。</p>
<p>难道是tcp丢包？上网查看相关资料，据说是tcp粘包（我也不太清楚具体问题），因为路由或者系统一般都把MTU限制在1500，如果数据包超过这数值，就会被拆封成小包来保证数据的准确性。</p>
<p>那问题就显而易见了，send传输太快，导致传输出现差错。于是，第一时间想到的是，在客户端或者服务器中加入unsleep()；</p>
<p>试了下，一开始unsleep的值很小的时候，传输还会出现差错。一步一步调试，在sever中加入recv返回值检验，recv返回值有三种情况，<0：传输失败、=0：另一端关闭、>0，返回成功收到的字节数。于是我加上了返回值检验，一旦返回值小于规定的返回值立刻停止传输，然后慢慢调整unsleep的值。可是，问题依然还有，这样虽然传输不会出现差错，可是速度立马降下来了，局域网之间传输只有80kb/s。。。</0：传输失败、=0：另一端关闭、></p>
<p>这时候。recv的最后一个参数引起了我的注意，这个参数一般默认设为0。会不会有其他参数能解决我这问题呢。man 2 recv，查阅数据手册<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SYNOPSIS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">ssize_t recv(<span class="built_in">int</span> s, void *buf, size_t len, <span class="built_in">int</span> flags)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">这是对recv函数的说明，翻到flag，有一个宏参数。</span><br><span class="line"></span><br><span class="line">MSG_WAITALL</span><br><span class="line">This flag requests that the operation block <span class="keyword">until</span> the full</span><br><span class="line">request is satisfied. However, the <span class="built_in">call</span> may still <span class="keyword">return</span> less</span><br><span class="line">data than requested <span class="keyword">if</span> a signal is caught, an error <span class="literal">or</span> discon-</span><br><span class="line">nect occurs, <span class="literal">or</span> the <span class="keyword">next</span> data <span class="keyword">to</span> be received is of a different</span><br><span class="line">type than that returned.</span><br></pre></td></tr></table></figure></p>
<p>大概意思就是，正常情况下，如果不设置MSG_WAITALL,那么系统使用SO_RCVLOWAT和参数length这两者较小的值，如果设置MSG_WAITALL那么使用参数length的值，如果前面计算的长度值为0，那么使用长度1，最后当socket读到的数据满足前面的长度时才返回。由于默认SO_RCVLOWAT为1字节长，所以可以认为，当不设置MSG_WAITALL时只要大于一个字节的数据就立即返回，而设置MSG_WAITALL时不少于length参数长度时才返回。</p>
<p>这样传输速度的问题就解决了。实测可以达到6 mb/s。哈哈。很理想了。</p>
<p>下面是整个代码，包含文件长度检验、上传进度、消耗时间、网速模拟等等<br>client:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ret = read(file, file_send_buf.buff, BUFF_MAX);</span><br><span class="line">    size_all_temp = size_all_temp + BUFF_MAX;</span><br><span class="line"></span><br><span class="line">    file_send_buf.flag = <span class="number">1001</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((ret &gt;= <span class="number">0</span>) &amp;&amp; (ret &lt; BUFF_MAX))</span><br><span class="line">    &#123;</span><br><span class="line">        file_send_buf.last_file_size = ret;</span><br><span class="line">        file_send_buf.flag = <span class="number">1000</span>;</span><br><span class="line">        send(soc, &amp;file_send_buf, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">file_send_recv</span></span>), MSG_WAITALL);</span><br><span class="line">        break_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(read);</span><br><span class="line">        exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> != break_flag)</span><br><span class="line">    &#123;</span><br><span class="line">    	send(soc, &amp;file_send_buf, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">file_send_recv</span></span>), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    memset(&amp;file_send_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">file_send_recv</span></span>));</span><br><span class="line">    <span class="comment">//usleep(10000);</span></span><br><span class="line"></span><br><span class="line">    file_size_uploaded_temp = i * BUFF_MAX;</span><br><span class="line">    file_size_uploaded = (<span class="keyword">float</span>)file_size_uploaded_temp;</span><br><span class="line">    percent = (file_size_uploaded / file_size) * <span class="number">100</span>;</span><br><span class="line">    mvwprintw(file_upload_win, <span class="number">1</span>, <span class="number">1</span>, <span class="string">" UPLOAGING… "</span>);</span><br><span class="line"></span><br><span class="line">    wattron(file_upload_win, COLOR_PAIR(<span class="number">7</span>));</span><br><span class="line">    wprintw(file_upload_win, <span class="string">"%4.2f%% "</span>, percent);</span><br><span class="line">    wattroff(file_upload_win, COLOR_PAIR(<span class="number">7</span>));</span><br><span class="line">    wprintw(file_upload_win, <span class="string">"%s "</span>, internet_speed);</span><br><span class="line"></span><br><span class="line">    uploaded_per = (<span class="keyword">int</span>)((percent / <span class="number">100</span>) * (width – <span class="number">2</span>));</span><br><span class="line">    wmove(file_upload_win, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    wattron(file_upload_win, COLOR_PAIR(<span class="number">6</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(temp = <span class="number">0</span>; temp &lt; uploaded_per; temp++)</span><br><span class="line">    &#123;</span><br><span class="line">    	wprintw(file_upload_win, <span class="string">" "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    wattroff(file_upload_win, COLOR_PAIR(<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line">    wattron(file_upload_win, COLOR_PAIR(<span class="number">5</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(temp = <span class="number">0</span>; temp &lt; (COLS / <span class="number">2</span> – <span class="number">2</span> – uploaded_per); temp++)</span><br><span class="line">    &#123;</span><br><span class="line">   		 wprintw(file_upload_win, <span class="string">" "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    wattroff(file_upload_win, COLOR_PAIR(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    mvwprintw(file_upload_win, <span class="number">3</span>, <span class="number">1</span>, <span class="string">" Time passed: %ds File size:%s "</span> , second, file_size_format);</span><br><span class="line"></span><br><span class="line">    wborder(file_upload_win, ‘<span class="params">|’, ‘|</span>’, ‘-’,'-’,'+’,'+’,'+’,'+’);</span><br><span class="line">    wrefresh(file_upload_win);</span><br><span class="line">    wmove(send_msg_win, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    wrefresh(send_msg_win);</span><br><span class="line">    i++;</span><br><span class="line"></span><br><span class="line">    time(&amp;time_middle);</span><br><span class="line">    speed_temp = second;</span><br><span class="line">    second = difftime(time_middle, time_begin);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(second != speed_temp)</span><br><span class="line">    &#123;</span><br><span class="line">        get_internet_speed(size_all_temp, internet_speed);</span><br><span class="line">        size_all_temp = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == break_flag)</span><br><span class="line">    &#123;</span><br><span class="line">   		 <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    i++;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;rece_file, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> file_send_recv));</span><br><span class="line">    ret = recv(soc, &amp;rece_file, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> file_send_recv), MSG_WAITALL);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    perror(recv);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">1000</span> == rece_file.flag)</span><br><span class="line">&#123;</span><br><span class="line">    write(file, rece_file.buff, rece_file.last_file_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"File_recv_over\n"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    ret = write(file, rece_file.buff, BUFF_MAX);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">    perror(write);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果图：</p>
<p><img src="http://o8yrrj7hr.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720150217232414.png" alt="1"></p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2015/07/18/解决socket传输中数据丢失问题/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-编译openwrt时覆盖配置文件" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/03/30/编译openwrt时覆盖配置文件/">编译openwrt时覆盖配置文件</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openwrt/">openwrt</a></li></ul>
</div>
        <time datetime="2015-03-30T15:52:00.000Z" itemprop="datePublished" class="post-tiem">
  2015-03-30
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <h1 id="编译openwrt时覆盖配置文件"><a href="#编译openwrt时覆盖配置文件" class="headerlink" title="编译openwrt时覆盖配置文件"></a>编译openwrt时覆盖配置文件</h1><p>最近又重操旧业，把openwrt拿出来玩。</p>
<p>一直以来想解决的问题，今天终于在google上搜到，留作备忘（我就不说百度有多渣了）</p>
<p>当学会了搭建openwrt编译环境，肯定是想编译有一些自己想要的东西固件，要知道官方给的固件是很简洁的，不仅没有web界面(Luci-web)，连无线默认都不是开启的，这也太不像个无线路由器的样子了。</p>
<p>我们会使用make kernelconfig和make menuconfig这种方法来自定义软件包，不过，这样编译出来的固件仍然不具个性化，因为，无线仍然没有开启，像SSID、路由主机名、默认网关等等这些还是openwrt官方的默认值。那么现在，我们就通过接下来的步骤做些个性化的修改。</p>
<p>在编译目录下新建一个名为files的目录，openwrt在编译的时候，会把files文件夹里的文件编译到固件的根目录，简而言之，就是/openwrt/trunk/files目录，这相当于是openwrt固件的根目录/（这个和上面提及的/openwrt/trunk/package/base-files/files目录作用相似），所以能在这个目录下能干的事情就多了，基本上涵盖了所有你能改动的东西。</p>
<p>这里只要模仿openwrt的/etc目录修改配置文件就可以了，下面对这些目录及文件作简单说明：</p>
<table>
<thead>
<tr>
<th>Tables</th>
<th style="text-align:center">Are</th>
</tr>
</thead>
<tbody>
<tr>
<td>/www/</td>
<td style="text-align:center">luci web页面的目录。</td>
</tr>
<tr>
<td>/etc/banner</td>
<td style="text-align:center">命令行登陆Openwrt的欢迎信息</td>
</tr>
<tr>
<td>/etc/opkg.conf</td>
<td style="text-align:center">Openwrt的opkg更新源配置文件</td>
</tr>
<tr>
<td>/etc/profile</td>
<td style="text-align:center">系统环境变量</td>
</tr>
<tr>
<td>/etc/dnsmasq.conf</td>
<td style="text-align:center">Dns解析配置文件</td>
</tr>
<tr>
<td>/etc/config/dhcp</td>
<td style="text-align:center">Dhcp服务配置文件</td>
</tr>
<tr>
<td>/etc/config/firewall</td>
<td style="text-align:center">防火墙配置文件</td>
</tr>
<tr>
<td>/etc/config/fstab</td>
<td style="text-align:center">文件系统挂载配置文件</td>
</tr>
<tr>
<td>/etc/config/luci</td>
<td style="text-align:center">Luci界面配置文件</td>
</tr>
<tr>
<td>/openwrt/trunk/package/base-files/files/etc/config/system</td>
<td style="text-align:center">系统主机名、时区、NTP及LED配置文件</td>
</tr>
<tr>
<td>/etc/config/wireless</td>
<td style="text-align:center">无线配置文件</td>
</tr>
</tbody>
</table>
<p>注意：编译openwrt是不能使用root账户的，别忘记配置好/openwrt/trunk/files目录属组及权限，不然编译时会出现各种奇葩的问题。最懒得方法是把权限改成777，命令：chmod 777 /openwrt/trunk/files -R</p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2015/03/30/编译openwrt时覆盖配置文件/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-To-Fast-Furious" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/03/25/To-Fast-Furious/">To Fast &amp; Furious</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/电影/">电影</a></li></ul>
</div>
        <time datetime="2015-03-25T13:59:00.000Z" itemprop="datePublished" class="post-tiem">
  2015-03-25
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>最后一段可能会是我观影史上最喜欢的谢幕，它以一个最完美的方式给保罗做了告别。</p>
<p>在这最后一幕，出场的两位主角不再是 DOM 与奥康纳，而就是范迪塞尔和保罗，在这段的表演个人觉得已经超脱于表演了，这段是拍给保罗的，也是拍给范迪塞尔的，更是拍给所有从速激1一路跟过来的老观众的。</p>
<p>结幕开场时，DOM一个人开车正在离开，他脸上展现了一种不属于DOM 这个角色的伤感、无奈。很明显这时的表情属于范迪塞尔，然后 背景音乐《SEE YOU AGAIN》的主旋律响起，“奥康纳”驾驶了一架纯白的跑车从 DOM 的一旁出现了。</p>
<p>“Thought you gonna leave without saying goodbye?” 奥康纳问，脸上露出了灿烂的笑容。</p>
<p>CG 合成的保罗的脸几乎完全无法看出瑕疵，他灿烂地微笑着，把正在观影的我也从感伤于失去保罗的情绪拉回到了“奥康纳”身上来。在银屏上的奥康纳没有因车祸而亡，而是从此金盆洗手，与妻儿共享天伦之余，还能与兄弟开车并驾齐驱。此刻的奥康纳是最幸福的奥康纳。</p>
<p>刚刚愁云密布的DOM 在看到奥康纳后也浮现了笑容，而我不觉得范迪塞尔此时的笑容属于表演，他笑时的眼神里还是有着悲伤，但他的笑容却也丝毫没有虚假的痕迹，这笑容可能就是范迪塞尔当时的情绪，他应该是真的很高兴，也很释然。</p>
<p>保罗与范迪塞尔戏里戏外都是兄弟，戏里DOM为奥康纳这个兄弟感到高兴，戏外范迪塞尔也可能应该感觉到了保罗在天堂对他发自内心的微笑，This is the one last ride, brother.</p>
<p>接着二人便开始了每部结尾必有的“一对一飙车“，但这次二人完全没有了往日地极速奔驰、你争我赶的架势，而是一直缓缓地，平静地并驾齐驱，</p>
<p>此时画面开始闪回速激1-6中 DOM 和奥康纳从青涩到成熟的画面，背景音乐也越来越激昂。</p>
<p>当闪回结束，镜头回到二人时，一个向西的分岔路出现了，奥康纳缓缓地向西驶去，DOM 继续向前，二人并没有说再见，也没有回头。两辆车平稳而坚定地向各自的方向驶去。</p>
<p>航拍镜头逐渐升高，跟着奥康纳的白色跑车往远景的阳光驶去，画面十分温暖，背景音乐也达到了最高潮的和声部分。奥康纳与保罗驶向了阳光，奥康纳回到了温暖的家，保罗则去到了一个更好的地方。</p>
<p>最后的这幕不是表演，它不是普普通通能演出来的，这一幕的感情太过真挚，不管何时回想都让我无比震撼与感动</p>
<p>最后引用一下DOM对保罗最后的台词作结吧</p>
<p>“I used to say I live my life a quarter mile at a time and I think that’s why we were brothers- because you did, too. No matter where you are, whether it’s a quarter mile away or half way across the world. The most important thing in life, will always be the people in this room. Salute mi familia. You’ll always be with me… And you’ll always be my brother.”</p>
<p>For Paul</p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2015/03/25/To-Fast-Furious/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-Openwrt拨号结果" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/01/11/Openwrt拨号结果/">Openwrt拨号结果</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openwrt/">openwrt</a></li></ul>
</div>
        <time datetime="2015-01-12T06:22:00.000Z" itemprop="datePublished" class="post-tiem">
  2015-01-11
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>目前只是一个linux 文件编程小练习，在openwrt shell下面可以正常运行。至于在luci上。。有一个函数</p>
<p>luci.sys.exec (command)  </p>
<p>Execute a given shell command and capture its standard output</p>
<p>参考 ：<a href="http://luci.subsignal.org/api/luci/modules/luci.sys.html" target="_blank" rel="external">http://luci.subsignal.org/api/luci/modules/luci.sys.html</a></p>
<p>大家可以试试,这里面的command是dial_result。</p>
<p>下面提供源码，大家可以根据自己的喜好改makefile定义自己的command</p>
<p>c代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">found</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> success[] = <span class="string">"CHAP authentication succeeded: "</span>;</span><br><span class="line"><span class="keyword">char</span> fail[] = <span class="string">"CHAP authentication failed: "</span>;</span><br><span class="line"><span class="keyword">char</span> unable[] = <span class="string">"Unable to complete PPPoE Discovery"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *succ = success;</span><br><span class="line"><span class="keyword">char</span> *fai = fail;</span><br><span class="line"><span class="keyword">char</span> *unab = unable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *temp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> flag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(*ptr != ‘\<span class="number">0</span>’)</span><br><span class="line">&#123;</span><br><span class="line">temp = ptr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*ptr == *unab ) <span class="comment">//unable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>(*ptr == *unab)</span><br><span class="line">&#123;</span><br><span class="line">ptr++;</span><br><span class="line">unab++;</span><br><span class="line"><span class="keyword">if</span>(*ptr == ‘v’)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*ptr == ‘v’)</span><br><span class="line">&#123;</span><br><span class="line">ptr = temp;</span><br><span class="line"><span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr = temp;</span><br><span class="line">unab = unable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*ptr == *succ) <span class="comment">//success</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>(*ptr == *succ)</span><br><span class="line">&#123;</span><br><span class="line">ptr++;</span><br><span class="line">succ++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*succ == ‘\<span class="number">0</span>’)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr = temp;</span><br><span class="line">succ = success;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*ptr == *fai) <span class="comment">//fail</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>(*ptr == *fai)</span><br><span class="line">&#123;</span><br><span class="line">ptr++;</span><br><span class="line">fai++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(*fai == ‘\<span class="number">0</span>’)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr = temp;</span><br><span class="line">fai = fail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_line</span><span class="params">(<span class="keyword">int</span> flag,<span class="keyword">char</span> *temp,<span class="keyword">int</span> len)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">char</span> tem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; len; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(read(flag,&amp;tem,<span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">"read error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(tem == ‘\n’)</span><br><span class="line">&#123;</span><br><span class="line">temp[i] = ‘\<span class="number">0</span>’;</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">temp[i] = tem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">temp[i] = ‘\<span class="number">0</span>’;</span><br><span class="line"><span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">dial</span><span class="params">(<span class="keyword">char</span> *txt)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> flag; <span class="comment">//dial_txt</span></span><br><span class="line"><span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *resul;</span><br><span class="line"><span class="keyword">char</span> end_file;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> temp[<span class="number">500</span>];</span><br><span class="line"><span class="keyword">char</span> c[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">char</span> dial_result[<span class="number">10</span>][<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">flag = open(txt, O_RDWR,<span class="number">0655</span>); <span class="comment">//open dial_txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">-1</span> == flag)</span><br><span class="line">&#123;</span><br><span class="line">perror(<span class="string">"error :"</span>); <span class="comment">//open error</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lseek(flag,<span class="number">0</span>,SEEK_SET);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">memset</span>(temp,<span class="number">0</span>,<span class="keyword">sizeof</span>(temp));</span><br><span class="line">read_line(flag,temp,MAX);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(end = read(flag,&amp;end_file,<span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lseek(flag,<span class="number">-1</span>,SEEK_CUR);</span><br><span class="line">resul = found(temp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(resul != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">strcpy</span>(dial_result[j], resul);</span><br><span class="line">j++;</span><br><span class="line">resul = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">close(flag);</span><br><span class="line"><span class="keyword">if</span>(j == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"Dialing,Please wait for a while!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dial_result[j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">system(<span class="string">"logread &gt; /tmp/logread.txt"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> txt[<span class="number">100</span>] = <span class="string">"/tmp/logread.txt"</span>;</span><br><span class="line"><span class="keyword">char</span> *temp = dial(txt);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(temp != <span class="string">"Dialing,Please wait for a while!"</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s\n"</span>,temp);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Dialing,Please wait for a while!\n"</span>);</span><br><span class="line">sleep(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2015/01/11/Openwrt拨号结果/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-Openwrt-SDK-编译生成ipk过程" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2014/06/30/Openwrt-SDK-编译生成ipk过程/">Openwrt SDK 编译生成ipk过程</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openwrt/">openwrt</a></li></ul>
</div>
        <time datetime="2014-07-01T06:19:00.000Z" itemprop="datePublished" class="post-tiem">
  2014-06-30
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>首先你要了解自己的openwrt版本号，以及自己的cpu构架。<br>ipk包是在一个构架里面的所有cpu的都能运行的，所以，比如你ipk在AR9331上能运行，也能在AR9344、AR9341…所有AR71XX构架的cpu上运行，但是在写一些特殊程序的时候，需要根据机型来安装。<br>进入<a href="http://downloads.openwrt.org" target="_blank" rel="external">http://downloads.openwrt.org</a> 里面选择你的openwrt版本号。进而选择自己的构架，然后找到sdk。</p>
<p>以AR71XX的AA版本为例(attitude_adjustment)，<a href="http://downloads.openwrt.org/attitude_adjustment/12.09/ar71xx/generic/" target="_blank" rel="external">http://downloads.openwrt.org/attitude_adjustment/12.09/ar71xx/generic/</a></p>
<p>选择OpenWrt-SDK-ar71xx-for-linux-i486-gcc-4.6-linaro_uClibc-0.9.33.2.tar.bz2，下载到本地，并传到虚拟机里面。</p>
<p>新建自己的packages<br>对于自己新建的package，而这个package又不需要随固件一起安装，换句话说，就是可以当做一个可选软件包的话。我们可以利用我们的SDK环境来单独编译，编译后会生成一个ipk的文件包。然后利用 opkg install xxx.ipk 来安装这个软件。<br>下面具体说下，如何编译一个helloword的软件包。<br>（1）首先，编写helloworld程序<br>编写helloworld.c<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"><span class="bullet">* </span>Helloworld.c</span><br><span class="line"><span class="bullet">* </span>The most simplistic C program ever written.</span><br><span class="line"><span class="bullet">* </span>An epileptic monkey on crack could write this code.</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**/</span></span></span><br><span class="line">#include</span><br><span class="line">#include</span><br><span class="line"><span class="built_in">int</span> main(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">printf(“Hell! O’ world, why won’t my code compile?\n\n”);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编写Makefile文件<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">build</span> <span class="selector-tag">helloworld</span> <span class="selector-tag">executable</span> <span class="keyword">when</span> user executes “make”</span><br><span class="line"><span class="attribute">helloworld</span>: helloworld.o</span><br><span class="line">$(CC) $(LDFLAGS) helloworld.o -o helloworld</span><br><span class="line">helloworld.<span class="attribute">o</span>: helloworld.c</span><br><span class="line">$(CC) $(CFLAGS) -c helloworld.c</span><br><span class="line"># remove object files <span class="keyword">and</span> executable <span class="keyword">when</span> user executes “make clean”</span><br><span class="line"><span class="attribute">clean</span>:</span><br><span class="line">rm *.o helloworld</span><br></pre></td></tr></table></figure></p>
<p>在这两个文件的目录下，执行make 应该可以生成helloworld的可执行文件。执行helloworld后，能够打印出“Hell! O’ world, why won’t my code compile?”。这一步，主要保证我们的源程序是可以正常编译的。下面我们将其移植到OpenWRT上。<br>（2）将OpenWrt-SDK-ar71xx-for-linux-i486-gcc-4.6-linaro_uClibc-0.9.33.2.tar.bz解压<br>tar –xvfOpenWrt-SDK-ar71xx-for-linux-i486-gcc-4.6-linaro_uClibc-0.9.33.2.tar.bz<br>（3）进入SDK<br>cd OpenWrt-SDK-ar71xx-for-linux-i486-gcc-4.6-linaro_uClibc-0.9.33.2.tar.bz<br>可以看到里面的目录结构跟我们之前source的目录结构基本相同，所需要编译的软件包，需要放置在package目录下<br>（4）在package目录下创建helloworld目录<br>cd package<br>mkdir helloworld<br>cd helloworld<br>（5）创建src目录，拷贝 helloworld文件<br>mkdir src<br>cp /home/wrt/test/helloworld.c src<br>cp /home/wrt/test/Makefile src<br>（6）在helloworld目录下创建Makefile文件<br>这个Makefile文件是给OpenWRT读的，而之前写的那个Makefile文件是针对helloworld给编译其读的。两个Makefile不在同一层目录下。<br>touch Makefile<br>vim Makefile<br>Makefile文件模板内容如下：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OpenWrt Makefile for helloworld program</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Most of the variables used here are defined in</span></span><br><span class="line"><span class="comment"># the include directives below. We just need to</span></span><br><span class="line"><span class="comment"># specify a basic description of the package,</span></span><br><span class="line"><span class="comment"># where to build our program, where to find</span></span><br><span class="line"><span class="comment"># the source files, and where to install the</span></span><br><span class="line"><span class="comment"># compiled program on the router.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be very careful of spacing in this file.</span></span><br><span class="line"><span class="comment"># Indents should be tabs, not spaces, and</span></span><br><span class="line"><span class="comment"># there should be no trailing whitespace in</span></span><br><span class="line"><span class="comment"># lines that are not commented.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(</span>TOPDIR)/rules.mk</span><br><span class="line"><span class="comment"># Name and release number of this package</span></span><br><span class="line"><span class="symbol">PKG_NAME:</span>=helloworld</span><br><span class="line"><span class="symbol">PKG_RELEASE:</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This specifies the directory where we’re going to build the program.</span></span><br><span class="line"><span class="comment"># The root build directory, $(BUILD_DIR), is by default the build_mipsel</span></span><br><span class="line"><span class="comment"># directory in your OpenWrt SDK directory</span></span><br><span class="line">PKG_BUILD_DIR <span class="symbol">:</span>= <span class="variable">$(</span>BUILD_DIR)/<span class="variable">$(</span>PKG_NAME)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(</span>INCLUDE_DIR)/package.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify package information for this program.</span></span><br><span class="line"><span class="comment"># The variables defined here should be self explanatory.</span></span><br><span class="line"><span class="comment"># If you are running Kamikaze, delete the DESCRIPTION</span></span><br><span class="line"><span class="comment"># variable below and uncomment the Kamikaze define</span></span><br><span class="line"><span class="comment"># directive for the description below</span></span><br><span class="line">define Package/helloworld</span><br><span class="line"><span class="symbol">SECTION:</span>=utils</span><br><span class="line"><span class="symbol">CATEGORY:</span>=Utilities</span><br><span class="line"><span class="symbol">TITLE:</span>=Helloworld — prints a snarky message</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment portion below for Kamikaze and delete DESCRIPTION variable above</span></span><br><span class="line">define Package/helloworld/description</span><br><span class="line">If you can’t figure out what this program does, you’re probably</span><br><span class="line">brain-dead <span class="keyword">and</span> need immediate medical attention.</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify what needs to be done to prepare for building the package.</span></span><br><span class="line"><span class="comment"># In our case, we need to copy the source files to the build directory.</span></span><br><span class="line"><span class="comment"># This is NOT the default. The default uses the PKG_SOURCE_URL and the</span></span><br><span class="line"><span class="comment"># PKG_SOURCE which is not defined here to download the source from the web.</span></span><br><span class="line"><span class="comment"># In order to just build a simple program that we have just written, it is</span></span><br><span class="line"><span class="comment"># much easier to do it this way.</span></span><br><span class="line">define Build/Prepare</span><br><span class="line">mkdir -p <span class="variable">$(</span>PKG_BUILD_DIR)</span><br><span class="line"><span class="variable">$(</span>CP) ./src/* <span class="variable">$(</span>PKG_BUILD_DIR)/</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line"><span class="comment"># We do not need to define Build/Configure or Build/Compile directives</span></span><br><span class="line"><span class="comment"># The defaults are appropriate for compiling a simple program such as this one</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify where and how to install the program. Since we only have one file,</span></span><br><span class="line"><span class="comment"># the helloworld executable, install it by copying it to the /bin directory on</span></span><br><span class="line"><span class="comment"># the router. The $(1) variable represents the root directory on the router running</span></span><br><span class="line"><span class="comment"># OpenWrt. The $(INSTALL_DIR) variable contains a command to prepare the install</span></span><br><span class="line"><span class="comment"># directory if it does not already exist. Likewise $(INSTALL_BIN) contains the</span></span><br><span class="line"><span class="comment"># command to copy the binary file from its current location (in our case the build</span></span><br><span class="line"><span class="comment"># directory) to the install directory.</span></span><br><span class="line">define Package/helloworld/install</span><br><span class="line"><span class="variable">$(</span>INSTALL_DIR) <span class="variable">$(</span><span class="number">1</span>)/bin</span><br><span class="line"><span class="variable">$(</span>INSTALL_BIN) <span class="variable">$(</span>PKG_BUILD_DIR)/helloworld <span class="variable">$(</span><span class="number">1</span>)/bin/</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line"><span class="comment"># This line executes the necessary commands to compile our program.</span></span><br><span class="line"><span class="comment"># The above define directives specify all the information needed, but this</span></span><br><span class="line"><span class="comment"># line calls BuildPackage which in turn actually uses this information to</span></span><br><span class="line"><span class="comment"># build a package.</span></span><br><span class="line"><span class="variable">$(</span>eval <span class="variable">$(</span>call BuildPackage,helloworld))</span><br></pre></td></tr></table></figure></p>
<p>（7）返回到SDK的根目录<br>执行make进行编译<br>编译过程会在build_dir目录下完成<br>编译结果会放在 bin/[yourtarget]/package目录下helloworld_1_ar71xx.ipk<br>（8）上传helloworld_1_ar71xx.ipk<br>使用winscp软件上传helloworld_1_ar71xx.ipk至路由器<br>执行 opkg install helloworld_1_ar71xx.ipk<br>输入helloworld<br>执行 helloworld 查看程序的效果。<br>Hell! O’ world, why won’t my code compile?</p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2014/06/30/Openwrt-SDK-编译生成ipk过程/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-c语言大数相加-相乘" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2014/06/24/c语言大数相加-相乘/">c语言大数相加&amp;相乘</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C语言/">C语言</a></li></ul>
</div>
        <time datetime="2014-06-25T00:13:00.000Z" itemprop="datePublished" class="post-tiem">
  2014-06-24
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>因为32位int类型最大的数是2147483647。所以在进行大数相加或者相乘的时候，会导致溢出。<br>下面是我自己写的大数相加&amp;相乘的程序。乘有两个版本，但是multiply_v1用的add叠加，导致速度太慢太慢。。<br>但是既然写好了就不扔了，放上面以后可能看看。。<br>multity_v2速度倒是蛮快的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 21.16*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">char</span> *number)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *head = number;</span><br><span class="line">    <span class="keyword">char</span> *num = number;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">99999</span>;</span><br><span class="line">    <span class="keyword">while</span>(*num != ‘\<span class="number">0</span>’)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((*num &lt; ’<span class="number">0</span>′) || (*num &gt; ’<span class="number">9</span>′))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Input Error! I can’t count!\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        num++;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    number[i] = ‘\<span class="number">0</span>’;</span><br><span class="line">    i–;</span><br><span class="line">    num–;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(num &gt;= head)</span><br><span class="line">    &#123;</span><br><span class="line">        number[i] = *num;</span><br><span class="line">        i–;</span><br><span class="line">        num–;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(;i &gt;=<span class="number">0</span>;i–)</span><br><span class="line">    &#123;</span><br><span class="line">    	number[i] = ’<span class="number">0</span>′;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">add</span><span class="params">(<span class="keyword">char</span> *num1,<span class="keyword">char</span> *num2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> result[<span class="number">100000</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *temp = result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">    	result[i] = ’<span class="number">0</span>′;</span><br><span class="line">    &#125;</span><br><span class="line">    result[<span class="number">99999</span>] = ‘\<span class="number">0</span>’;</span><br><span class="line"></span><br><span class="line">    prepare(num1);</span><br><span class="line">    prepare(num2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">99998</span>; i &gt;= <span class="number">0</span>; i–)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="keyword">if</span>((num1[i] + num2[i] + carry – ’<span class="number">0</span>′) &gt; ’<span class="number">9</span>′)</span><br><span class="line">        &#123;</span><br><span class="line">            result[i] = num1[i] + num2[i] + carry – ’<span class="number">0</span>′ – <span class="number">10</span>;</span><br><span class="line">            carry = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            result[i] = num1[i] + num2[i] + carry – ’<span class="number">0</span>′;</span><br><span class="line">            carry = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(result[i] == ’<span class="number">0</span>′)</span><br><span class="line">    &#123;</span><br><span class="line">        temp++;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sheet</span><span class="params">(<span class="keyword">char</span> *num1,<span class="keyword">int</span> num2,<span class="keyword">char</span> *temp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    prepare(temp);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">99998</span>;</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> carry_temp[<span class="number">100000</span>];</span><br><span class="line">    <span class="keyword">char</span> *temp_temp = temp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *head = num1;</span><br><span class="line">    <span class="keyword">while</span>(*num1 != ‘\<span class="number">0</span>’)</span><br><span class="line">    &#123;</span><br><span class="line">    	num1++;</span><br><span class="line">    &#125;</span><br><span class="line">    num1–;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(num1 &gt;= head)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">      temp[i] = ((*num1 – ’<span class="number">0</span>′)*num2 + carry) % <span class="number">10</span> + ’<span class="number">0</span>′;</span><br><span class="line">      carry = ((*num1 – ’<span class="number">0</span>′)*num2 + carry) / <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">      num1–;</span><br><span class="line">      i–;</span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(temp[i] == ’<span class="number">0</span>′)</span><br><span class="line">    &#123;</span><br><span class="line">        temp_temp++;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(carry_temp,temp_temp);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp,carry_temp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ten_multiply</span><span class="params">(<span class="keyword">char</span> *number,<span class="keyword">int</span> digit)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *p = number;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(*p != ‘\<span class="number">0</span>’)</span><br><span class="line">  &#123;</span><br><span class="line">  		p++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; digit; i++)</span><br><span class="line">  &#123;</span><br><span class="line">  		*p = ’<span class="number">0</span>′;</span><br><span class="line"> 		 p++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *p = ‘\<span class="number">0</span>’;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">multiply_v2</span><span class="params">(<span class="keyword">char</span> *num1,<span class="keyword">char</span> *num2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> result[<span class="number">100000</span>] = <span class="string">"0"</span>;</span><br><span class="line">    <span class="keyword">char</span> result_temp[<span class="number">100000</span>] = <span class="string">"0"</span>;</span><br><span class="line">    <span class="keyword">char</span> *temp = result;</span><br><span class="line">    <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *num2_temp = num2;</span><br><span class="line">    <span class="keyword">char</span> *num2_head = num2;</span><br><span class="line">    <span class="keyword">while</span>(*num2_temp != ‘\<span class="number">0</span>’)</span><br><span class="line">    &#123;</span><br><span class="line">    	num2_temp++;</span><br><span class="line">    &#125;</span><br><span class="line">    num2_temp–;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(num2_temp &gt;= num2_head)</span><br><span class="line">    &#123;</span><br><span class="line">        sheet(num1,*num2_temp – ’<span class="number">0</span>′,result_temp);</span><br><span class="line">        ten_multiply(result_temp,number);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(result,add(result_temp,result));</span><br><span class="line">        number++;</span><br><span class="line">        num2_temp–;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(*temp == ’<span class="number">0</span>′)</span><br><span class="line">    &#123;</span><br><span class="line">   		 temp++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">multiply_v1</span><span class="params">(<span class="keyword">char</span> *num1,<span class="keyword">char</span> *num2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> result[<span class="number">100000</span>] = <span class="string">"0"</span>;</span><br><span class="line">    <span class="keyword">char</span> result_temp[<span class="number">100000</span>] = <span class="string">"0"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> number = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *num2_temp = num2;</span><br><span class="line">    <span class="keyword">char</span> *num2_head = num2;</span><br><span class="line">    <span class="keyword">char</span> *temp = result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(*num2_temp != ‘\<span class="number">0</span>’)</span><br><span class="line">    &#123;</span><br><span class="line">    		num2_temp++;</span><br><span class="line">    &#125;</span><br><span class="line">    num2_temp–;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(num2_temp &gt;= num2_head)</span><br><span class="line">    &#123;</span><br><span class="line">          <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; ((*num2_temp – ’<span class="number">0</span>′)*<span class="built_in">pow</span>(<span class="number">10</span>,number<span class="number">-1</span>)); i++)</span><br><span class="line">          &#123;</span><br><span class="line">          <span class="built_in">strcpy</span>(result_temp,add(result_temp,num1));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">strcpy</span>(result,add(temp,result_temp));</span><br><span class="line">          <span class="built_in">strcpy</span>(result_temp,<span class="string">"0"</span>);</span><br><span class="line">          number++;</span><br><span class="line">          num2_temp–;</span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(result[i] == ’<span class="number">0</span>′)</span><br><span class="line">    &#123;</span><br><span class="line">          temp++;</span><br><span class="line">          i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> num1[<span class="number">100000</span>];</span><br><span class="line">    <span class="keyword">char</span> num2[<span class="number">100000</span>];</span><br><span class="line">    <span class="keyword">char</span> result[<span class="number">100000</span>] = <span class="string">"1"</span>;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input num1 :"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,num1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input num2 :"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,num2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input how do u want to count (+ or *) :"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%c"</span>,&amp;c);</span><br><span class="line">    <span class="keyword">if</span>(c == ‘+’)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(result,add(num1,num2));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"num + num2 = %s\n"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(c == ‘*’)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(result,multiply_v2(num1,num2));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"num * num2 = %s\n"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    		<span class="built_in">printf</span>(<span class="string">"Input error!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2014/06/24/c语言大数相加-相乘/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
    <li class="post-list-item">
  <article id="post-AR9331-AR9344-网口、Led修正方法" class="article article-type-post" itemprop="blogPost">
    
      


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2014/05/14/AR9331-AR9344-网口、Led修正方法/">AR9331/AR9344 网口、Led修正方法</a>
    </h3>
  



      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openwrt/">openwrt</a></li></ul>
</div>
        <time datetime="2014-05-14T14:23:00.000Z" itemprop="datePublished" class="post-tiem">
  2014-05-14
</time>
      </div>
      <div class="post-content" id="post-content" itemprop="postContent" >
        
          <p>不同的openwrt版本可能不太一样，但是大致差不多。以官方attitude_adjustment版本为例。</p>
<p>#注:在改代码之前请先make clean。</p>
<p>AR9331网口修正方法：以编译tl-wr741n-v4固件为例，找到文件mach-tl-wr741nd-v4.c，在目<br>录</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attitude_adjustment<span class="meta-keyword">/target/</span>linux<span class="meta-keyword">/ar71xx/</span>files<span class="meta-keyword">/arch/</span>mips<span class="meta-keyword">/ath79/</span></span><br></pre></td></tr></table></figure>
<p>下，找到代码</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ath79_setup_ar933x_phy4_switch(<span class="literal">true</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ath79_setup_ar933x_phy4_switch(<span class="literal">false</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>或者直接删掉。</p>
<p>AR9331 Led修正方法 ：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tl-wr741nd-v4</span>)</span><br><span class="line"><span class="selector-tag">ucidef_set_led_netdev</span> “<span class="selector-tag">wan</span>” “<span class="selector-tag">WAN</span>” “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:wan</span>” “<span class="selector-tag">eth1</span>″</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan1</span>″ “<span class="selector-tag">LAN1</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan1</span>″ “<span class="selector-tag">switch0</span>″ “0×04”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan2</span>″ “<span class="selector-tag">LAN2</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan2</span>″ “<span class="selector-tag">switch0</span>″ “0×08”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan3</span>″ “<span class="selector-tag">LAN3</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan3</span>″ “<span class="selector-tag">switch0</span>″ “0×10”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan4</span>″ “<span class="selector-tag">LAN4</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan4</span>″ “<span class="selector-tag">switch0</span>″ “0×02”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_wlan</span> “<span class="selector-tag">wlan</span>” “<span class="selector-tag">WLAN</span>” “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:wlan</span>” “<span class="selector-tag">phy0tpt</span>”</span><br></pre></td></tr></table></figure>
<p>改成</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ucidef_set_led_netdev</span> “<span class="selector-tag">wan</span>” “<span class="selector-tag">WAN</span>” “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:wan</span>” “<span class="selector-tag">eth1</span>″</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan1</span>″ “<span class="selector-tag">LAN1</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan1</span>″ “<span class="selector-tag">switch0</span>″ “0×02”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan2</span>″ “<span class="selector-tag">LAN2</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan2</span>″ “<span class="selector-tag">switch0</span>″ “0×04”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan3</span>″ “<span class="selector-tag">LAN3</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan3</span>″ “<span class="selector-tag">switch0</span>″ “0×08”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_switch</span> “<span class="selector-tag">lan4</span>″ “<span class="selector-tag">LAN4</span>″ “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:lan4</span>″ “<span class="selector-tag">switch0</span>″ “0×10”</span><br><span class="line"><span class="selector-tag">ucidef_set_led_wlan</span> “<span class="selector-tag">wlan</span>” “<span class="selector-tag">WLAN</span>” “<span class="selector-tag">tp-link</span><span class="selector-pseudo">:green</span><span class="selector-pseudo">:wlan</span>” “<span class="selector-tag">phy0tpt</span>”</span><br></pre></td></tr></table></figure>
<p>AR9341网口修正方法：以编译tl-wr841n-v8固件为例，在刚才的目录下找到文件mach-tl-wr841n-v8.c，将代码</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ath<span class="number">79</span>_setup_ar<span class="number">934</span>x_eth_cfg<span class="comment">(AR934X_ETH_CFG_SW_PHY_SWAP)</span>;改为ath<span class="number">79</span>_setup_ar<span class="number">934</span>x_eth_cfg<span class="comment">(AR934X_ETH_CFG_SW_ONLY_MODE)</span>;</span><br><span class="line">ath<span class="number">79</span>_switch_data.phy_poll_mask = BIT<span class="comment">(0)</span>;</span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ath<span class="number">79</span>_switch_data.phy_poll_mask = BIT<span class="comment">(4)</span>;</span><br><span class="line">ath<span class="number">79</span>_eth<span class="number">0</span>_data.phy_mask = BIT<span class="comment">(0)</span>;改为ath<span class="number">79</span>_eth<span class="number">0</span>_data.phy_mask = BIT<span class="comment">(4)</span>;</span><br></pre></td></tr></table></figure>
<p>此项为修改内核的方法，不会随着make clean而被还原。</p>
<p>上述修改方法适用于pppoe拨号、DHCP动态IP地址和静态IP地址环境。<br>led灯的修正请根据具体机型修改匹配。</p>

        
      </div>
      <div class="post-footer clearfix">
        <a href="/2014/05/14/AR9331-AR9344-网口、Led修正方法/" class="post-more waves-effect waves-button waves-light">MORE</a>
      </div>
    

  </article>


</li>
  
  </ul>
  
    <nav id="page-nav">
      <div class="inner">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
      </div>
    </nav>
  


    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "Bwelco",
    pic: "http://o8yrrj7hr.bkt.clouddn.com/HexoHead.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://bwelco.coding.me/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>



<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>









</body>
</html>
